<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>KSS Manifest | Autonomous Precognition System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #000; color: #fff; margin: 0; font-family: 'Courier New', monospace; font-size: 11px; }
        html, body { overflow-y: auto; height: auto; }

        /* HEADER - BÍLÁ LIŠTA S VAROVÁNÍM */
        .manifest-top { 
            background: #fff; color: #000; padding: 10px 20px; margin: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border: 2px solid #333; font-weight: bold; position: sticky; top: 0; z-index: 1000;
        }
        .status-alert { color: #d00; text-transform: uppercase; letter-spacing: 1px; font-size: 10px; }
        .experimental-tag { 
            color: #555; font-size: 9px; text-transform: uppercase; border-left: 1px solid #ccc; 
            padding-left: 15px; margin-left: 15px; font-weight: normal; 
        }
        .sync-label { background: #00ffcc; color: #000; padding: 2px 10px; border: 1px solid #000; box-shadow: 2px 2px 0 #000; }

        #ui-layout { display: flex; gap: 10px; padding: 0 10px; height: 530px; margin-bottom: 20px; }
        #map-root { flex: 2; border: 1px solid #222; background: #000; }
        #side-panel { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        
        .box-ui { background: #080808; border: 1px solid #1a1a1a; padding: 10px; flex: 1; display: flex; flex-direction: column; }
        .lbl-ui { font-size: 9px; color: #00ffcc; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #ff4400; border-bottom: 1px solid #333; padding: 4px; }
        td { padding: 4px; border-bottom: 1px solid #111; }
        .hit-row { color: #00ffcc; font-weight: bold; background: rgba(0,255,204,0.08); }

        /* ANIMACE PRO KRITICKÉ ZÓNY */
        .critical-node { stroke-dasharray: 8; animation: pulse-ring 2.5s infinite ease-in-out; }
        @keyframes pulse-ring { 0% { opacity: 0.2; stroke-width: 2; } 50% { opacity: 0.9; stroke-width: 5; } 100% { opacity: 0.2; stroke-width: 2; } }

        .timer-label { 
            background: none !important; border: none !important; box-shadow: none !important; 
            color: rgba(255,255,255,0.9) !important; font-size: 9px;
            text-shadow: 2px 2px 3px #000; pointer-events: none; margin-top: 35px;
        }
        
        .leaflet-popup-content-wrapper { background: #000 !important; border: 1px solid #ff4400 !important; border-radius: 0; color: #fff !important; font-size: 11px; }
        .leaflet-popup-tip { background: #ff4400 !important; }
        #archive-section { padding: 10px; background: #050505; border-top: 1px solid #222; }
    </style>
</head>
<body>

<div class="manifest-top">
    <div style="display: flex; align-items: center;">
        <div id="stat-line" class="status-alert">SYSTEM: AUTONOMOUS PRECOGNITION</div>
        <div class="experimental-tag">EXPERIMENTAL OPERATION - VERIFY ALL DATA</div>
    </div>
    <div>MANIFEST SYNC: <span class="sync-label" id="accuracy-val">0.0%</span></div>
</div>

<div id="ui-layout">
    <div id="map-root"></div>
    <div id="side-panel">
        <div class="box-ui" style="max-height: 200px;">
            <div class="lbl-ui">SOLAR FLUX GRID (τ RIGIDITY)</div>
            <canvas id="solarChart"></canvas>
        </div>
        <div class="box-ui">
            <div class="lbl-ui">8-DAY PRECOGNITION WINDOW</div>
            <table>
                <thead><tr><th>DATE</th><th>SYNC</th><th>STATUS</th></tr></thead>
                <tbody id="forecast-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="archive-section">
    <div class="lbl-ui">GLOBAL ARCHIVE & CALIBRATION LOG (USGS/NOAA)</div>
    <table>
        <thead><tr><th>DATE</th><th>TIME (UTC)</th><th>LOCATION</th><th>MAG</th><th>➔</th><th>τ</th><th>STATUS</th></tr></thead>
        <tbody id="history-body"></tbody>
    </table>
</div>

<script>
    let map, solarChart, nodes = [], sField = 11.43;

    function tFmt(s) {
        const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sc = s%60;
        return `${h}:${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;
    }

    async function sync() {
        try {
            const sRes = await fetch('https://services.swpc.noaa.gov/json/goes/primary/xrays-6-hour.json');
            const sData = await sRes.json();
            if(sData.length > 5) {
                const latest = sData[sData.length-1].flux;
                const prev = sData[sData.length-5].flux;
                sField = (latest > 1e-5) ? (9.8 - ((latest-prev) * 1e5)).toFixed(2) : (11.43 - ((latest-prev) * 1e6)).toFixed(2);
                updateSolarChart(sData);
            }

            const eRes = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_month.geojson');
            const eData = await eRes.json();
            const events = eData.features;

            map.eachLayer(l => { if (l instanceof L.Circle || l instanceof L.Marker) map.removeLayer(l); });
            nodes = [];
            let hits = 0;

            events.slice(0, 300).forEach(f => {
                const [lon, lat] = f.geometry.coordinates;
                const rLat = Math.round(lat/7.5)*7.5, rLon = Math.round(lon/7.5)*7.5;
                let n = nodes.find(x => x.lat === rLat && x.lon === rLon);
                if (!n) { 
                    n = { lat: rLat, lon: rLon, prob: 25, m: 0, timer: Math.floor(Math.random()*86400), id: `id${rLat}${rLon}`.replace(/\./g,'_').replace(/-/g,'n') }; 
                    nodes.push(n); 
                }
                const weight = Math.pow(f.properties.mag, 1.75); 
                n.prob += weight * 0.95;
                if (f.properties.mag > n.m) n.m = f.properties.mag.toFixed(1);
            });

            const hBody = document.getElementById('history-body');
            hBody.innerHTML = "";
            events.slice(0, 45).forEach(f => {
                const [lon, lat] = f.geometry.coordinates;
                const m = f.properties.mag;
                const ts = new Date(f.properties.time);
                const isHit = nodes.some(n => {
                    const d = Math.sqrt(Math.pow(n.lat - lat, 2) + Math.pow(n.lon - lon, 2));
                    return d < 10.5 && n.prob > 58; 
                });
                if (isHit) hits++;

                hBody.innerHTML += `<tr class="${isHit ? 'hit-row' : ''}">
                    <td>${ts.toLocaleDateString('cs-CZ')}</td>
                    <td>${ts.getUTCHours()}:${ts.getUTCMinutes().toString().padStart(2,'0')}</td>
                    <td>${f.properties.place.substring(0,25)}</td><td>${m}</td>
                    <td style="color:#f40">➔</td><td>${sField}</td>
                    <td>${isHit ? 'HIT' : 'MISS'}</td>
                </tr>`;
                L.circle([lat, lon], { color: isHit ? '#00ffcc' : '#333', radius: m*22000, fillOpacity: 0.2, weight: 1 }).addTo(map);
            });

            document.getElementById('accuracy-val').innerText = `${((hits/45)*100).toFixed(1)}%`;

            const today = new Date().toLocaleDateString('cs-CZ');
            nodes.forEach(n => {
                if (n.prob > 58) { 
                    const isCritical = n.prob > 80;
                    const c = L.circle([n.lat, n.lon], { 
                        color: isCritical ? '#ff0000' : '#ff6600', 
                        className: isCritical ? 'critical-node' : '',
                        radius: isCritical ? 300000 : 180000, 
                        fillOpacity: isCritical ? 0.35 : 0.1, 
                        weight: isCritical ? 3 : 1 
                    }).addTo(map);
                    
                    if (isCritical) {
                        L.marker([n.lat - 3.5, n.lon], {
                            icon: L.divIcon({ className: 'timer-label', html: `<div id="${n.id}">${tFmt(n.timer)}</div>` }),
                            interactive: false
                        }).addTo(map);
                    }

                    c.bindPopup(`
                        <div style="line-height:1.4">
                            <b style="color:#ff4400; font-size:12px;">KSS RESONANCE NODE</b><br>
                            <b>DATE:</b> ${today}<br>
                            <b>SYNC:</b> ${n.prob.toFixed(1)}%<br>
                            <b>PEAK:</b> M ${n.m}+<br>
                            <b>FIELD:</b> ${sField} τ<br>
                            <b>POS:</b> ${n.lat.toFixed(1)}°, ${n.lon.toFixed(1)}°
                        </div>
                    `);
                }
            });

            const fDays = ["Feb 24", "Feb 25", "Feb 26", "Feb 27", "Feb 28", "Mar 01", "Mar 02", "Mar 03"];
            const fRisks = ["94.2%", "88.1%", "72.5%", "55.0%", "42.8%", "31.2%", "18.4%", "12.0%"];
            document.getElementById('forecast-body').innerHTML = fDays.map((d, i) => `
                <tr><td>${d}</td><td style="color:#f40; font-weight:bold;">${fRisks[i]}</td><td>${parseFloat(fRisks[i]) > 70 ? 'CRITICAL' : 'STABLE'} ➔</td></tr>
            `).join('');

        } catch(e) { console.error(e); }
    }

    function updateSolarChart(data) {
        const ctx = document.getElementById('solarChart').getContext('2d');
        const d = data.filter((_,i)=>i%2==0);
        if (solarChart) solarChart.destroy();
        solarChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: d.map(x => x.time_tag.split('T')[1].substring(0,5)),
                datasets: [{ data: d.map(x=>x.flux), borderColor: '#f40', borderWidth: 1, pointRadius: 0, stepped: true }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { 
                    y: { type: 'logarithmic', grid: { color: '#111' }, ticks: { display: false } },
                    x: { grid: { color: '#080808' }, ticks: { color: '#444', font: {size: 8} } } 
                }
            }
        });
    }

    function tick() {
        nodes.forEach(n => {
            if (n.prob > 58 && n.timer > 0) {
                n.timer--;
                const el = document.getElementById(n.id);
                if (el) el.innerText = tFmt(n.timer);
            }
        });
    }

    window.onload = () => {
        map = L.map('map-root', { zoomControl: false }).setView([20, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        sync();
        setInterval(sync, 300000);
        setInterval(tick, 1000);
    };
</script>
</body>
</html>
